{% extends "base.html" %}

{% block title %}Панель управления{% endblock %}

{% block custom_head %}

<style type="text/css">
.pattern {
  width: 170px;
}

</style>
{% endblock %}

{% block content %}
    <!-- <h1 class="page-header">Статистика</h1> -->

<div class="container-fluid">
{% for phone,pattern in patterns.iteritems %}
  <div class="pull-left pattern">
  <span class="badge">{{phone}}</span><br>

    <script type="text/javascript+protovis">
    var nba = {{pattern | safe}};

    /* Convert from tabular format to array of objects. */
    var cols = nba.shift();
    nba = nba.map(function(d) pv.dict(cols, function() d[this.index]));
    cols.shift();

    /* The color scale ranges 3 standard deviations in each direction. */
    var x = pv.dict(cols, function(f) pv.mean(nba, function(d) d[f])),
        s = pv.dict(cols, function(f) pv.deviation(nba, function(d) d[f])),
     fill = pv.dict(cols, function(f) pv.Scale.linear()
            .domain(-3 * s[f] + x[f], 3 * s[f] + x[f])
            .range("white", "blue"));

    /* The cell dimensions. */
    var w = 20, h = 15;

    var vis = new pv.Panel()
        .width(cols.length * w)
        .height(nba.length * h)
        .top(10)
        .left(15);

    vis.add(pv.Panel)
        .data(cols)
        .left(function() this.index * w)
        .width(w)
      .add(pv.Panel)
        .data(nba)
        .top(function() this.index * h)
        .height(h)
        .fillStyle(function(d, f) fill[f](d[f]))
        .strokeStyle("white")
        .lineWidth(1)
        .antialias(false)
        .title(function(d, f) d.Name + "'s " + f + ": " + d[f]);

    vis.add(pv.Label)
        .data(cols)
        .left(function() this.index * w)
        .top(-5)
        .textAngle(0)
        .textBaseline("middle");

    vis.add(pv.Label)
        .data(nba)
        .top(function() this.index * h + h / 2)
        .left(0)
        .textAlign("right")
        .textBaseline("middle")
        .text(function(d) d.Name);

    vis.render();

    </script>
  </div>
{% endfor %}


</div>



    <div id="demo"></div>
    <script type="text/javascript">
        var context = cubism.context()
                            .step(6e4) // Distance between data points in milliseconds
                            .size(400) // Number of data points
                            .stop(); // Fetching from a static data source; don't update values

        d3.select("body").append("div") // Add a vertical rule
          .attr("class", "rule") // to the graph
          .call(context.rule());

        function stock(name) {
            return context.metric(function(start, stop, step, callback) {
                d3.json("patterns/" + name + ".json", function(rows) {
                    var compare = rows[0][1], value = rows[0][1], values = [value];
                    
                    // Creates an array of the price differences throughout the day
                    rows.forEach(function(d) {
                        values.push(value = (d[1] - compare) / compare);
                    });
                callback(null, values); });
            }, name);
        }


        function draw_graph(stocks_list) {
            d3.select("#demo") // Select the div on which we want to act
              .selectAll(".axis") // This is a standard D3 mechanism to
              .data(["top"]) // bind data to a graph. In this case
              .enter() // we're binding the axes "top" and "bottom".
              .append("div") // Create two divs and
              .attr("class", function(d) { // give them the classes
                return d + " axis"; // top axis and bottom axis
              }) // respectively
              .each(function(d) { // For each of these axes,
                d3.select(this) // draw the axes with 4 intervals
                  .call(context.axis() // and place them in their proper places
                  .ticks(4).orient(d));
              });


            d3.select("#demo")
              .selectAll(".horizon")
              .data(stocks_list.map(stock))
              .enter()
              .insert("div", ".bottom") // Insert the graph in a div
              .attr("class", "horizon") // Turn the div into
              .call(context.horizon() // a horizon graph
              .format(d3.format("+,.2p"))); // Format the values to 2 floating-point decimals


            context.on("focus", function(i) {
                d3.selectAll(".value").style("right", // Make the rule coincide
                    i == null ? null : context.size() - i + "px"); // with the mouse
            });
        }

        draw_graph(["XX"]);
    </script>

{% endblock %}
